# Kia Token Generator

A tool for generating refresh tokens for the Kia Connect API (Europe), designed for integration with Home Assistant through the `hyundai_kia_connect_api`.

## Requirements

- Python 3.8+
- Google Chrome
- ChromeDriver (must be in PATH)
- Libraries: `selenium`, `requests`

## Installation

Install the required dependencies:

```bash
pip install selenium requests
```

Or use the requirements file:

```bash
pip install -r requirements.txt
```

**ChromeDriver Installation:**
- Download ChromeDriver from: https://chromedriver.chromium.org/downloads
- Choose the version matching your Chrome version
- Extract and add to PATH

**OR** use the automatic manager:
```bash
pip install webdriver-manager
```

Then modify the code:
```python
from webdriver_manager.chrome import ChromeDriverManager
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)
```

## Usage

Run the script:

```bash
python KIA_TOKEN.py
```

The script will:
1. Open a Chrome browser window
2. Navigate to the Kia Connect login page
3. Wait for you to log in manually
4. Automatically capture the authorization code
5. Exchange it for a refresh token
6. Display the token in the console

## Token Usage with Home Assistant

The resulting refresh token should be used as the "password" in the configuration of the `kia_uvo` / `hyundai_kia_connect` integration in Home Assistant.

When configuring the integration:
- **Username**: Your Kia Connect email address
- **Password**: The refresh token generated by this script

## Important Notes

- ‚ö†Ô∏è **This script works ONLY for the European Kia region**
- ‚ùå **Does NOT work with Hyundai accounts**
- üîí The refresh token is long (500-1000+ characters) - this is normal
- üîê Store the token securely and do not share it
- ‚è∞ The token may expire after some time - run the script again to get a new one

## Example Output

```
Opening login page: https://idpconnect-eu.kia.com/auth/...

==================================================
Please log in manually in the browser window.
The script will wait for you to complete the login...
==================================================

‚úÖ Login successful! Element found.

Navigating to redirect URL to get code...

Current URL after redirect: https://prd.eu-ccapi.kia.com:8080/api/...

‚úÖ Authorization code extracted: abcd1234efgh5678ijkl...

==================================================
‚úÖ SUCCESS!
==================================================

Use this token instead of your password:

eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

==================================================

Cleaning up and closing the browser.
```

## Troubleshooting

### Error: `'NoneType' object has no attribute 'group'`

If you encounter this error, make sure you are using the latest version of `KIA_TOKEN.py` from this repository. 

**Do NOT use the older script `KiaFetchApiTokensSelenium.py` from the wiki** - it has known issues that have been fixed in this version.

### Error: ChromeDriver not found
- Make sure ChromeDriver is installed and added to PATH
- Or use `webdriver-manager` as described in the installation section

### Error: Timeout during login
- The script waits up to 5 minutes for login completion
- Make sure you're logging in within the opened browser window
- Check your internet connection

### Error: Timed out waiting for authorization code redirect
- The login page may have closed too quickly
- Try running the script again
- Make sure you complete the login process fully

### Error: Could not find authorization code in URL
- Check if the login completed successfully
- Check your internet connection
- Try running the script again

### Error: Error getting tokens from the API
- The authorization token may be invalid or expired
- Try running the script again and log in from scratch
- Verify you're using a European Kia account

## Configuration Parameters

In the `KIA_TOKEN.py` file you can review (but typically don't need to modify):

- `CLIENT_ID` - Kia API client ID
- `BASE_URL` - Authorization API base URL
- `LOGIN_URL` - Login page URL
- `REDIRECT_URL_FINAL` - Redirect URL after authorization

## License

Use at your own risk. The script is intended for personal use only.